# Bindings

# Prefix, this is important because C-b is page up in Vim
unbind C-b
# This is rotate window, which I don't use and it's confusing to hit when
# closing other windows with `o`
unbind M-o
set-option -g prefix M-s
# set-option -g prefix M-W
# In Mosh, sometimes this key is sent for `M-s`
set-option -g prefix2 ß

# bind-key M-W select-pane -t :.+
bind-key M-s select-pane -t :.+
bind-key M-S select-pane -t :.-
bind-key S select-pane -t :.-

# Equal size panes
bind-key = select-layout even-vertical

bind-key v split-window -h -c "#{pane_current_path}"
bind-key s split-window -c "#{pane_current_path}"
bind-key t new-window -a -c "#{pane_current_path}"
bind-key M-n next-window
bind-key M-p previous-window
bind-key T break-pane
bind-key c kill-pane
bind-key o "kill-pane -a"
bind-key q confirm-before kill-window
bind-key Q confirm-before kill-session
bind-key Enter resize-pane -Z

bind-key B list-keys
bind-key M-a choose-tree -s
bind-key a choose-tree -s
# `M-S` doesn't work over `ssh` from iPad
# Mmemonic for this is `M-s M-x`, which is the invert of `C-x C-s` which is
# save in Emacs (a stretch I know...)
bind -n End send-key C-e
bind -n Home send-key C-a

# bind-key y run-shell "safepaste | tmux load-buffer - && tmux paste-buffer -p"
bind-key y paste-buffer -p
bind-key M-y paste-buffer -p
bind-key M-v copy-mode \; send-keys -X begin-selection

# For some reason adding the `-b` flag makes these not freeze
bind-key z run-shell -b 'tmux_switch'
bind-key M-z run-shell -b 'tmux_switch_window'

# Move
bind-key N swap-window -d -t :+1
bind-key P swap-window -d -t :-1

# New Session
bind-key + new
bind-key A new
# This conflicts with using ESC to cancel
# bind-key Escape run-shell 'tmux_shell_new'
bind-key ` run-shell 'tmux_shell_new'
bind-key M-` run-shell 'tmux_shell_new'
# This is an error on startup
# bind-key C-` run-shell 'tmux_shell_new'
# bind-key C-@ run-shell 'tmux_shell_new'

bind-key C-^ switch-client -l
bind-key ^ last-window
# Bind BS and C-BS
# bind-key M-BSpace switch-client -l
# bind-key BSpace last-window
# bind-key BSpace run-shell 'tmux_last'
# bind-key BSpace switch-client -l
bind-key Tab switch-client -l

# Init
bind-key i source-file ~/.tmux.conf \; display "Sourced"
# Can't display "Sourced" because that will overwrite error messages
# bind-key i source-file ~/.tmux.conf

# Next Pane
bind-key C-w select-pane -t :.+
bind-key w select-pane -t :.+
bind-key W select-pane -t :.-
bind-key M-w select-pane -t :.+
bind-key T break-pane -t :

# Synchronize
bind-key m set -g mouse \; display "Mouse toggled"
bind-key M set-window-option synchronize-panes \; display "Synchronize toggled"

# Movement
# bind-key h select-pane -L
# bind-key j select-pane -D
# bind-key k select-pane -U
# bind-key l select-pane -R
# bind-key M-h select-pane -L
# bind-key M-j select-pane -D
# bind-key M-k select-pane -U
# bind-key M-l select-pane -R

# Resize
# bind-key -r H resize-pane -L 5
# bind-key -r J resize-pane -D 5
# bind-key -r K resize-pane -U 5
# bind-key -r L resize-pane -R 5

# Copy Mode
# Make search incremental
# `rectangle-on` `rectangle-off` clears the search highlighting
bind-key u copy-mode \; send -X search-backward " " \; \
	send-key -X search-again \; \
	send-key -X cursor-down \; \
	send-key -X select-line \; \
	send -X search-forward " " \; \
	send-key -X cursor-up \; \
	send-key -X rectangle-on \; \
	send-key -X rectangle-off
bind-key -T copy-mode u send -X search-backward " " \; \
	send-key -X cursor-down \; \
	send-key -X select-line \; \
	send -X search-forward " " \; \
	send-key -X cursor-up \; \
	send-key -X rectangle-on \; \
	send-key -X rectangle-off
bind-key -T copy-mode-vi u send -X search-backward " " \; \
	send-key -X cursor-down \; \
	send-key -X select-line \; \
	send -X search-forward " " \; \
	send-key -X cursor-up \; \
	send-key -X rectangle-on \; \
	send-key -X rectangle-off

bind-key C-b copy-mode -u
bind-key b copy-mode -u
# emacs
bind-key -T copy-mode C-r command-prompt -i -I \
	"#{pane_search_string}" -p "(search up)" \
	"send -X search-backward-incremental \"%%%\""
bind-key -T copy-mode C-s command-prompt -i -I \
	"#{pane_search_string}" -p "(search down)" \
	"send -X search-forward-incremental \"%%%\""

# Override rectangular selection
# bind-key -T copy-mode-vi C-v send-keys -X page-down
bind-key -T copy-mode-vi Space send-keys -X page-down
bind-key -T copy-mode-vi BSpace send-keys -X page-up
bind-key -T copy-mode-vi NPage send-keys -X page-down
bind-key -T copy-mode-vi PPage send-keys -X page-up
# bind-key -T copy-mode M-{ send-keys -X previous-paragraph
# bind-key -T copy-mode M-} send-keys -X next-paragraph
# Start `emacs` `copy-mode`
bind-key PPage copy-mode \; send-keys -X page-up
bind-key BSpace copy-mode \; send-keys -X page-up

# Set after tmux resurrect because both use `C-r`
bind-key C-r copy-mode \; \
	command-prompt -i -I "#{pane_search_string}" -p \
	"(search up)" "send -X search-backward-incremental \"%%%\""
# bind-key C-r copy-mode \; \
# 	command-prompt -i -p "search up" \
# 	"send -X search-backward-incremental \"%%%\""
# Vim-style search
bind-key ? copy-mode \; \
	command-prompt -i -p "search up" \
	"send -X search-backward-incremental \"%%%\""
# bind-key M-k copy-mode \; send-keys -X cursor-up
bind-key k copy-mode \; send-keys -X cursor-up
# bind-key k copy-mode \; send-keys -X cursor-up \; send-keys -X start-of-line
bind-key K copy-mode \; send-keys -X cursor-up
bind-key Up copy-mode \; send-keys -X cursor-up
bind-key h copy-mode \; send-keys -X begin-selection \; send-keys -X cursor-left
bind-key l copy-mode \; send-keys -X begin-selection \; send-keys -X cursor-right

unbind-key C-s

bind-key M-x run-shell "~/.tmux/plugins/tmux-resurrect/scripts/save.sh"
bind-key x run-shell "~/.tmux/plugins/tmux-resurrect/scripts/save.sh"
# bind-key M-R run-shell "~/.tmux/plugins/tmux-resurrect/scripts/restore.sh"
